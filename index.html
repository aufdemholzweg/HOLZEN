<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Holz-Quartett: Gamifizierung in der Berufsbildung</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* DESIGN DEFINITIONEN */
        body { font-family: 'Inter', sans-serif; background-color: #fdfbf7; touch-action: manipulation; overflow-x: hidden; min-height: 100dvh; }
        .perspective-1000 { perspective: 1000px; }
        .card-3d { transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-flipped { transform: rotateY(180deg); }
        .card-front, .card-back { backface-visibility: hidden; position: absolute; width: 100%; height: 100%; top: 0; left: 0; border-radius: 1rem; overflow: hidden; box-sizing: border-box; }
        .card-back { 
            transform: rotateY(180deg); 
            background-color: #2c3e50;
            background-image: url('https://github.com/aufdemholzweg/holzquartett/blob/326bdfd40ff4d97de5c70dc584fe767aba056135/images/background_card.jpg?raw=true'); 
            background-size: cover; 
            background-position: center; 
            border: 4px solid white; 
        }
        .card-front-bg { background-color: #fffbeb; background-image: linear-gradient(to bottom right, #fffbeb, #fef3c7); }
        .hover-lift:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        
        .animate-pulse-glow { animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); transform: translate(-50%, -50%) scale(1); } 50% { box-shadow: 0 0 15px 5px rgba(34, 197, 94, 0.4); transform: translate(-50%, -50%) scale(1.1); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); transform: translate(-50%, -50%) scale(1); } }
        
        .animate-pop-in { animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes pop-in { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .animate-bounce-slam { animation: bounce-slam 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes bounce-slam { 0% { transform: scale(0); opacity: 0; } 60% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }

        @keyframes slide-up-bounce { 0% { transform: translateY(100%) rotate(10deg); opacity: 0; } 60% { transform: translateY(-20px) rotate(-5deg); opacity: 1; } 80% { transform: translateY(10px) rotate(5deg); } 100% { transform: translateY(0) rotate(0deg); opacity: 1; } }
        .animate-klotzi-popup { animation: slide-up-bounce 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        .opponent-back-name { position: absolute; top: 15%; width: 100%; text-align: center; color: rgba(255,255,255,0.95); font-weight: 700; font-size: 1.1rem; text-shadow: 0 2px 4px rgba(0,0,0,0.5); pointer-events: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .dimmer { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        
        .attr-box { background-color: #fff7ed; border: 1px solid #fbbf24; transition: all 0.2s; }
        .attr-box.flash-active { background-color: #f97316 !important; border-color: #ea580c !important; color: white !important; }
        .attr-box.flash-active span { color: white !important; }
        .attr-box.highlight-compare { background-color: #e5e7eb !important; border-color: #9ca3af !important; color: #111827 !important; }
        .attr-box.highlight-compare span { color: #000000 !important; }
        
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        .attr-toggle-btn { transition: all 0.2s; border: 2px solid transparent; }
        .attr-toggle-btn.selected { background-color: #fef3c7; border-color: #f59e0b; color: #92400e; }
        .attr-toggle-btn:not(.selected) { background-color: #f3f4f6; color: #9ca3af; border-color: transparent; }

        @keyframes pulse-dot-anim { 0%, 100% { transform: translate(50%, -50%) scale(1); } 50% { transform: translate(50%, -50%) scale(1.4); } }
        .animate-pulse-dot { animation: pulse-dot-anim 1s infinite ease-in-out; }
        @keyframes chargeWidth { from { width: 0%; } to { width: 100%; } }
        .animate-charge { animation: chargeWidth 1.5s linear forwards; }
        @keyframes shrinkWidth { from { width: 100%; } to { width: 0%; } }
        .animate-shrink { animation: shrinkWidth 10s linear forwards; }
    </style>
</head>
<body class="flex flex-col relative text-gray-800">

<header id="mainHeader" class="fixed top-0 left-0 w-full bg-gradient-to-r from-amber-500 to-orange-600 text-white shadow-md z-[120]">
    <div class="max-w-[600px] mx-auto px-4 py-3 relative flex justify-between items-center">
        <a id="navButton" href="#" class="relative z-[121] w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center text-white shadow-sm hover:bg-white/30 transition-all border border-white/30" aria-label="Navigation"></a>
        
        <h1 class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-lg sm:text-2xl font-black tracking-wider uppercase drop-shadow-sm whitespace-nowrap pointer-events-none">ğŸŒ² HOLZEN! ğŸŒ²</h1>
        
        <button id="ruleButton" onclick="window.showGameInfo()" class="text-white hover:text-amber-100 p-2 rounded-full transition-colors active:scale-90 relative z-[121]" aria-label="Spielregeln">
             <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
             </svg>
        </button>
    </div>
</header>

<div id="gameContainer" class="hidden flex-grow flex flex-col items-center w-full max-w-[600px] mx-auto relative p-2 pt-20 overflow-hidden">
    <div id="animationContainer" class="absolute inset-0 pointer-events-none z-50 overflow-hidden"></div>
    <div class="flex justify-center items-start gap-2 sm:gap-4 w-full flex-grow relative pb-2 mt-2"> 
        <div class="flex flex-col w-[48%] max-w-[280px] gap-2 z-10">
            <div class="bg-white w-full rounded-2xl shadow-sm border border-orange-100 p-2 sm:p-3 text-center">
                <div id="playerNameDisplay" class="text-base sm:text-lg font-bold text-amber-700 leading-tight truncate">Spieler</div>
                <div class="text-[10px] sm:text-sm text-gray-500 mt-0.5">Karten: <span id="playerCards" class="font-bold text-xl sm:text-2xl text-gray-800">15</span></div>
            </div>
            <div class="w-full aspect-[20/46] perspective-1000 relative" id="playerCardContainer"><div id="playerCard" class="w-full h-full relative"></div></div>
        </div>
        <div class="flex flex-col w-[48%] max-w-[280px] gap-2 z-10">
            <div class="bg-white w-full rounded-2xl shadow-sm border border-orange-100 p-2 sm:p-3 text-center">
                <div id="opponentNameDisplay" class="text-base sm:text-lg font-bold text-gray-600 leading-tight truncate">COMPUTER</div>
                <div class="text-[10px] sm:text-sm text-gray-500 mt-0.5">Karten: <span id="aiCards" class="font-bold text-xl sm:text-2xl text-gray-800">15</span></div>
            </div>
            <div class="w-full aspect-[20/46] perspective-1000 relative" id="aiCardContainer"><div id="aiCard" class="w-full h-full relative"></div></div>
        </div>
    </div>
    <div class="w-full mt-4 mb-24"> 
        <div class="flex justify-between text-[9px] sm:text-[10px] font-bold text-gray-400 mb-1 px-1"><span>Dein Stapel</span><span>Gegenspieler</span></div>
        <div class="h-4 w-full bg-gray-200 rounded-full shadow-inner relative">
            <div id="statusBar" class="h-full bg-amber-500 rounded-l-full transition-all duration-500 ease-out" style="width: 50%;"></div>
            <div id="statusBall" class="absolute top-1/2 w-6 h-6 rounded-full border-2 border-white shadow-md transition-all duration-500 ease-out z-10" style="left: 50%; transform: translate(-50%, -50%); background: radial-gradient(circle at 30% 30%, #fbbf24, #d97706);"></div>
        </div>
    </div>
</div>

<div id="happyKlotzi" class="fixed bottom-64 right-2 z-[100] transition-transform duration-500 translate-y-full hidden pointer-events-none flex flex-col items-center">
    <div id="happyKlotziText" class="bg-white border-4 border-black text-black font-black text-base sm:text-lg px-4 py-2 rounded-2xl mb-1 shadow-[4px_4px_0px_rgba(0,0,0,0.2)] animate-bounce relative text-center">
        Stark!
        <div class="absolute -bottom-3 left-1/2 -translate-x-1/2 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-t-[12px] border-t-black"></div>
        <div class="absolute -bottom-[9px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-[8px] border-l-transparent border-r-[8px] border-r-transparent border-t-[10px] border-t-white"></div>
    </div>
    <img src="https://github.com/aufdemholzweg/holzquartett/blob/main/images/klotzi_win.png?raw=true" alt="Jubel Klotzi" class="w-32 sm:w-40 filter drop-shadow-2xl">
</div>

<div id="tieOverlay" class="fixed inset-0 z-[90] flex items-center justify-center dimmer hidden pt-20">
    <div class="bg-white/10 backdrop-blur-md p-8 rounded-3xl animate-bounce-slam text-center border border-white/20 shadow-2xl relative">
        <img src="https://github.com/aufdemholzweg/holzquartett/blob/main/images/klotzi_quiz.png?raw=true" alt="Klotzi Quiz" class="w-32 mx-auto mb-2 object-contain filter drop-shadow-lg" onerror="this.style.display='none'">
        <div class="text-5xl mb-2 filter drop-shadow-lg">ğŸ’¥</div>
        <h2 class="text-4xl sm:text-5xl font-black text-white uppercase tracking-wider drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)]">GLEICHSTAND!</h2>
        <p class="text-white font-bold text-lg mt-3 drop-shadow-md bg-black/20 px-4 py-1 rounded-full inline-block">Das Quiz entscheidet...</p>
    </div>
</div>

<div id="quizModal" class="fixed inset-0 dimmer flex items-center justify-center z-[80] p-4 hidden pt-20">
    <div class="bg-white rounded-2xl shadow-2xl relative w-full max-w-sm flex flex-col animate-pop-in border-4 border-amber-500 overflow-visible">
        <div class="h-4 w-full bg-gray-200 relative overflow-hidden rounded-t-xl">
            <div id="quizTimerBar" class="h-full w-0 bg-amber-500 rounded-r-sm relative"> 
                <div class="absolute right-0 top-1/2 w-4 h-4 bg-white border-2 border-amber-600 rounded-full shadow z-10 animate-pulse-dot transform translate-x-1/2 -translate-y-1/2"></div>
            </div>
        </div>
        <div class="p-6 text-center relative z-10">
            <div id="quizStatusText" class="inline-block bg-amber-100 text-amber-800 text-xs font-bold px-2 py-1 rounded-full mb-3 relative z-30">âš ï¸ Gleichstand! Quiz lÃ¤dt...</div>
            <h3 id="quizQuestion" class="text-lg font-bold text-gray-800 mb-6 leading-tight min-h-[3rem] flex items-center justify-center relative z-30 px-2">Frage wird geladen...</h3>
            <div id="quizOptions" class="grid grid-cols-1 gap-3 relative z-30"></div>
            <div id="quizExplanation" class="hidden mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-gray-700 leading-snug shadow-sm animate-pop-in"></div>
        </div>
    </div>
</div>

<div id="bottomSheetBackdrop" class="hidden fixed inset-0 bg-black/20 z-30 transition-opacity"></div>
<div id="bottomSheet" class="hidden fixed left-0 right-0 bottom-0 z-40 flex justify-center px-2 pb-6 transition-transform transform translate-y-full duration-300">
    <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl border border-gray-200 w-full max-w-md p-5 flex flex-col items-center">
        <div id="turnIndicator" class="text-xs sm:text-sm font-semibold text-gray-500 mb-1"></div>
        <h3 id="resultText" class="text-xl sm:text-2xl font-black uppercase tracking-wide mb-2 text-gray-800"></h3>
        <p id="resultDetails" class="text-xs sm:text-sm text-gray-600 mb-6 font-mono bg-gray-100 px-3 py-1 rounded-lg"></p>
        <div class="flex gap-3 w-full">
            <button id="bsInfoBtn" class="flex-1 bg-amber-600 hover:bg-amber-700 active:scale-95 text-white font-bold py-3 px-4 rounded-xl shadow-lg border-b-4 border-amber-800 transition text-sm sm:text-base">ğŸ“ Zusatzwissen</button>
            <button id="bsNextBtn" class="flex-1 bg-green-600 hover:bg-green-700 active:scale-95 text-white font-bold py-3 px-4 rounded-xl shadow-lg border-b-4 border-green-800 transition text-sm sm:text-base">Weiter &rarr;</button>
        </div>
    </div>
</div>

<div id="gameInfoModal" class="fixed inset-0 dimmer flex items-center justify-center z-[130] p-4 hidden pt-20">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-[400px] max-h-[85vh] flex flex-col">
        <div class="bg-amber-500 p-4 flex justify-between items-center text-white shrink-0 shadow-md">
            <h3 class="font-bold text-lg">Spielregeln & Eigenschaften</h3>
            <button onclick="window.closeGameInfo()" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div class="p-5 overflow-y-auto hide-scrollbar space-y-5">
            <h4 class="font-bold text-gray-700 text-md">Regeln:</h4>
            <p class="text-sm text-gray-600 leading-relaxed">Die aktive Person wÃ¤hlt auf ihrer Karte die Eigenschaft, die den grÃ¶ÃŸtmÃ¶glichen Vorteil verspricht. Je nach Kategorie zÃ¤hlt der hÃ¶here oder der niedrigere Wert.</p>
            <h4 class="font-bold text-gray-700 text-md mt-4">Bei Gleichstand:</h4>
            <p class="text-sm text-gray-600 leading-relaxed">Haben beide Karten den gleichen Wert, startet fÃ¼r BEIDE Spieler ein Quiz! Wer die Frage innerhalb von 10 Sekunden am schnellsten richtig beantwortet, gewinnt.</p>
            <div id="infoCategoryList" class="space-y-3 pt-3"></div>
        </div>
    </div>
</div>

<div id="infoModal" class="fixed inset-0 dimmer flex items-center justify-center z-[160] p-4 hidden">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-md flex flex-col max-h-[80vh] mt-12">
        <div class="bg-amber-600 p-4 flex justify-between items-center text-white shrink-0">
            <h3 class="font-bold">Wissenskarte</h3>
            <button onclick="document.getElementById('infoModal').classList.add('hidden')" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div id="infoModalContent" class="p-5 overflow-y-auto flex-grow"></div>
    </div>
</div>

<div id="imageViewerModal" class="fixed inset-0 z-[200] flex items-center justify-center dimmer hidden p-4" onclick="window.closeImageViewer()">
    <div class="relative max-w-full max-h-full">
        <button onclick="window.closeImageViewer()" class="absolute -top-12 right-0 text-white text-3xl font-bold hover:text-gray-300 pointer-events-auto">&times;</button>
        <img id="fullSizeImage" src="" class="max-h-[85vh] max-w-[95vw] rounded-lg shadow-2xl object-contain border-4 border-white" onclick="event.stopPropagation()">
    </div>
</div>

<div id="impressumModal" class="fixed inset-0 z-[140] flex items-center justify-center p-4 dimmer hidden pt-20">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-sm flex flex-col max-h-[85vh]">
        <div class="bg-slate-700 p-4 flex justify-between items-center text-white shrink-0">
            <h3 class="font-bold">Impressum</h3>
            <button onclick="document.getElementById('impressumModal').classList.add('hidden')" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div class="p-6 overflow-y-auto text-sm text-gray-700 space-y-4">
            <div><h4 class="font-bold text-gray-900 mb-1">Angaben gemÃ¤ÃŸ Â§ 5 TMG</h4><p>Christopher Lehr<br>WaterloostraÃŸe 49<br>28201 Bremen</p></div>
            <div><h4 class="font-bold text-gray-900 mb-1">Kontakt</h4><p>E-Mail: christopher_lehr@web.de</p></div>
            <div><h4 class="font-bold text-gray-900 mb-1">Kontext</h4><p>Masterarbeit Lehramt Holztechnik, Leibniz UniversitÃ¤t Hannover.</p></div>
            <div><h4 class="font-bold text-gray-900 mb-1">Fachliche Grundlagen & Quellen</h4><p class="text-xs text-gray-500 mb-1">WagenfÃ¼hr, R. (2007). Holzatlas. MÃ¼nchen: Fachbuchverlag Leipzig.</p></div>
        </div>
    </div>
</div>

<div id="attrConfigModal" class="fixed inset-0 z-[120] flex items-center justify-center p-4 dimmer hidden pt-20">
    <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full max-w-sm flex flex-col max-h-[85vh]">
        <div class="bg-amber-600 p-4 flex justify-between items-center text-white shrink-0">
            <h3 class="font-bold">Spieloptionen</h3>
            <button onclick="window.closeAttrConfig()" class="text-white/80 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div class="p-4 overflow-y-auto">
            <div class="mb-5 space-y-3">
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100"><span class="font-bold text-gray-700 text-sm flex items-center gap-2">ğŸ”Š Ton an</span><input type="checkbox" id="soundToggle" class="accent-green-500 w-5 h-5"></div>
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100"><span class="font-bold text-gray-700 text-sm flex items-center gap-2">ğŸ‘€ Gegner-Karte sichtbar</span><input type="checkbox" id="revealBackToggle" class="accent-green-500 w-5 h-5"></div>
            </div>
            <hr class="border-gray-200 mb-4 border-t-2 border-dashed">
            <h4 class="font-bold text-gray-800 mb-1 text-sm">Eigenschaften wÃ¤hlen</h4>
            <div id="attrConfigList" class="space-y-2"></div>
        </div>
        <div class="p-4 bg-gray-50 border-t"><button onclick="window.closeAttrConfig()" class="w-full bg-amber-500 text-white font-bold py-2 rounded-lg shadow">Fertig</button></div>
    </div>
</div>

<div id="setupModal" class="fixed inset-0 z-[110] flex flex-col items-center justify-center p-4 dimmer overflow-y-auto h-screen">
    <div class="w-10 h-10 absolute left-4 top-4"></div>
    <a href="https://forms.office.com/r/dPiXWjBiGQ" target="_blank" class="absolute top-20 left-4 z-[120] bg-violet-600 hover:bg-violet-700 text-white font-bold w-10 h-10 rounded-full shadow-lg transition-transform active:scale-95 flex items-center justify-center border-2 border-white/20" title="Feedback zum Spiel"><span class="text-xl">ğŸ’¬</span></a>
    <div class="relative w-full max-w-sm pt-20">
        <img src="https://github.com/aufdemholzweg/holzquartett/blob/main/images/klotzi_menu.png?raw=true" alt="Klotzi MenÃ¼" class="absolute -top-4 -right-2 w-48 z-20 pointer-events-none transform rotate-3 drop-shadow-xl" onerror="this.style.display='none'">
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden w-full relative mb-6 z-10">
            <div class="bg-amber-500 p-5 text-white text-center font-bold text-lg sm:text-xl tracking-wide shadow-md">HOLZEN!<br><span class="text-sm font-normal opacity-90">Spielmodus wÃ¤hlen</span></div>
            <div class="p-6 space-y-4">
                <button onclick="window.showNamePrompt('ai')" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-3 active:scale-95 transition-transform"><span class="text-2xl">ğŸ¤–</span> Gegen Computer</button>
                <button onclick="window.showNamePrompt('multiplayer')" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-3 active:scale-95 transition-transform"><span class="text-2xl">ğŸŒ</span> Online gegen Freunde</button>
                <button onclick="window.openAttrConfig()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-xl border border-gray-200 flex items-center justify-center gap-2 text-sm mt-2"><span>âš™ï¸</span> Spieloptionen <span id="attrCountBadge" class="bg-amber-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">5</span></button>
            </div>
        </div>
        <div id="mainMenuStats" class="text-center hidden mb-8 relative z-10"></div>
        <div class="mt-auto pt-4 text-center relative z-10"><button onclick="document.getElementById('impressumModal').classList.remove('hidden')" class="text-white/70 text-xs font-medium hover:text-white underline transition-colors">Impressum</button></div>
    </div>
</div>

<div id="nameModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4 pt-20">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-xs w-full text-center relative overflow-visible">
        <img src="https://github.com/aufdemholzweg/holzquartett/blob/main/images/klotzi_name.png?raw=true" alt="Klotzi Name" class="absolute -top-24 left-1/2 -translate-x-1/2 w-48 pointer-events-none drop-shadow-xl z-20" onerror="this.style.display='none'">
        <div class="relative z-10 mt-16"> 
            <h2 class="text-xl font-bold text-gray-800 mb-6">Dein Name</h2>
            <input type="text" id="playerName" class="w-full p-3 border-2 border-gray-200 rounded-lg mb-6 text-center font-bold text-lg" placeholder="Name eingeben" maxlength="12">
            <button id="nameSubmitButton" class="w-full bg-amber-500 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-amber-600">Starten</button>
        </div>
    </div>
</div>

<div id="multiplayerLobbyModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4 pt-20">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center">
        <h2 id="lobbyTitle" class="text-xl font-bold text-amber-800 mb-2">Lobby</h2>
        <p id="lobbyText" class="text-sm text-gray-600 mb-4">Lass deinen Freund scannen:</p>
        <div class="flex justify-center mb-4"><div id="qrcode" class="p-2 bg-white rounded-lg border border-gray-200"></div></div>
        <div class="bg-gray-100 p-2 rounded mb-4 flex items-center gap-2">
            <input id="shareLink" type="text" class="bg-transparent text-xs w-full text-gray-600 font-mono" readonly>
            <button onclick="window.copyShareLink()" class="bg-white px-3 py-1 rounded text-xs font-bold border shadow-sm hover:bg-gray-50">Kopieren</button>
        </div>
        <p class="text-sm text-green-600 font-bold animate-pulse">Warte auf Mitspieler...</p>
    </div>
</div>

<div id="gameOverModal" class="hidden fixed inset-0 dimmer flex items-center justify-center z-50 p-4 pt-20">
    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full text-center relative overflow-visible">
        <style>
            .scene-stage { width: 100%; height: 220px; position: relative; background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 70%, #8D6E63 70%, #5D4037 100%); border-radius: 16px; overflow: hidden; border: 4px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.15); margin-bottom: 20px; }
            .klotzi-real { height: 100px; width: auto; position: absolute; bottom: 50px; left: 40px; z-index: 10; transform-origin: bottom center; animation: klotzi-logic 6s infinite ease-in-out; }
            .seed { font-size: 20px; position: absolute; bottom: 120px; left: 160px; opacity: 0; animation: seed-fall 6s infinite; }
            .big-tree { font-size: 120px; position: absolute; bottom: 35px; left: 110px; transform-origin: bottom center; transform: scale(0); filter: drop-shadow(5px 5px 5px rgba(0,0,0,0.2)); animation: tree-pop 6s infinite; }
            .sun-ray { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: repeating-conic-gradient(from 0deg, rgba(255,255,255,0.4) 0deg 10deg, transparent 10deg 20deg); animation: spin-sun 20s linear infinite; z-index: 0; }
            @keyframes klotzi-logic { 0% { transform: translateX(-100px); } 10% { transform: translateX(0); } 15% { transform: scaleY(0.9); } 20% { transform: scaleY(1); } 40% { transform: translateX(0); } 45% { transform: translateY(-20px) rotate(-10deg); } 50% { transform: translateY(0) rotate(0deg); } 55% { transform: translateY(-20px) rotate(10deg); } 60% { transform: translateY(0) rotate(0deg); } 100% { transform: translateY(0); } }
            @keyframes seed-fall { 0%, 10% { opacity: 0; transform: translateY(0); } 15% { opacity: 1; transform: translateY(0); } 25% { opacity: 1; transform: translateY(70px) scale(0.5); } 26%, 100% { opacity: 0; } }
            @keyframes tree-pop { 0%, 25% { transform: scale(0); } 35% { transform: scale(1.2); } 40% { transform: scale(0.9); } 45% { transform: scale(1); } 100% { transform: scale(1); } }
            @keyframes spin-sun { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        </style>
        <div class="scene-stage" role="img" aria-label="Animation: Klotzi pflanzt einen Baum">
            <div class="sun-ray"></div><img src="https://github.com/aufdemholzweg/holzquartett/blob/main/images/klotzi_win.png?raw=true" class="klotzi-real" alt="Klotzi"><div class="seed">ğŸŒ°</div><div class="big-tree">ğŸŒ³</div>
        </div>
        <div class="relative z-10 mt-4"> 
            <h2 id="gameOverTitle" class="text-3xl font-black mb-2 text-gray-800">SPIELENDE</h2>
            <p id="gameOverText" class="text-gray-600 mb-6"></p>
            <div class="space-y-3">
                <button onclick="window.showLeaderboard()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-3 rounded-lg border border-gray-300">ğŸ† Bestenliste</button>
                <button onclick="window.resetGame()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-lg shadow">ğŸ”„ Neues Spiel</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, deleteDoc, collection, query, orderBy, limit, getDocs, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyCyRXl8-JPr1xTXPDi1VG-eQk6fOnTpqUI", authDomain: "holzquartett-3a177.firebaseapp.com", projectId: "holzquartett-3a177", storageBucket: "holzquartett-3a177.appspot.com", messagingSenderId: "1081595025073", appId: "1:1081595025073:web:bc571fffb6e4f20b27f490", measurementId: "G-HKLWFJE83K" };
const activeConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'holzquartett-3a177';

let app, db, auth;
try { app = initializeApp(activeConfig); db = getFirestore(app); auth = getAuth(app); } catch (e) { console.error("Firebase Init Error:", e); }

const initAuth = async () => { try { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); } } catch (e) { console.error("Auth Failed", e); } };
initAuth();

const getPublicDataRef = (coll, docId) => { if(docId) return doc(db, 'artifacts', appId, 'public', 'data', coll, docId); return collection(db, 'artifacts', appId, 'public', 'data', coll); };
async function trackEvent(type) { if (!auth || !auth.currentUser) return; const ref = getPublicDataRef("statistics", "usage"); try { await setDoc(ref, { [type]: increment(1), last_activity: serverTimestamp() }, { merge: true }); } catch (e) {} }

// -------------------------------------------------------------
// NEUES LOGO IM JAVASCRIPT EINGEBAUT
// -------------------------------------------------------------
const NAV_ICONS = {
    // Hier ist das Logo eingebunden:
    logo: `<img src="https://github.com/aufdemholzweg/holzquartett/blob/main/images/holzlogo.png?raw=true" alt="Holztechnik Logo" class="w-full h-full object-contain rounded-md">`,
    house: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></svg>`
};

function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
window.setNavState = (state) => { 
    const btn = document.getElementById('navButton'); 
    if(!btn) return; 
    btn.onclick = null; 
    
    if(state === 'game') { 
        btn.innerHTML = NAV_ICONS.house; 
        btn.removeAttribute('href'); 
        btn.onclick = (e) => { 
            e.preventDefault(); 
            if(confirm('Spiel abbrechen?')) { 
                if(typeof unsubscribeGame === 'function') unsubscribeGame(); 
                window.location.href = window.location.origin + window.location.pathname; 
            } 
        }; 
    } else if (state === 'name_input') { 
        btn.innerHTML = NAV_ICONS.house; 
        btn.href = "#"; 
        btn.onclick = (e) => { 
            e.preventDefault(); 
            document.getElementById('nameModal').classList.add('hidden'); 
            document.getElementById('setupModal').classList.remove('hidden'); 
            window.setNavState('menu'); 
        }; 
    } else { 
        // HIER WIRD DAS LOGO GENUTZT
        btn.innerHTML = NAV_ICONS.logo; 
        btn.href = 'https://aufdemholzweg.github.io/Splashscreen-Holztechnik/'; 
    } 
};
window.setNavState('menu');

let gameMode=null, gameId=null, localPlayerId=null, unsubscribeGame=null, localGameState={}, hasCopiedShareLink=false, isMuted=false, roundSoundPlayed=false, lastRoundWinningWoodName = null;
let aiGame={playerName:'',playerCards:[],aiCards:[],currentPlayerCard:null,currentAiCard:null,roundInProgress:false,turn:'player'};

const attributeInfo={ dk:{ icon:'ğŸ›¡ï¸', name:'Dauerhaftigkeit', unit:'(DK)', logic: 'Niedrig gewinnt', default: true }, druckfestigkeit:{ icon:'ğŸ’', name:'Druckfestigkeit', unit:'(N/mmÂ²)', logic: 'Hoch gewinnt', default: true }, quellen:{ icon:'â†”ï¸', name:'Quellen/Schw.', unit:'(%)', logic: 'Niedrig gewinnt', default: true }, rohdichte:{ icon:'âš–ï¸', name:'Rohdichte', unit:'(kg/mÂ³)', logic: 'Hoch gewinnt', default: true }, emodul:{ icon:'ğŸ“', name:'E-Modul', unit:'(N/mmÂ²)', logic: 'Hoch gewinnt', default: true }, preis:{ icon:'ğŸ’°', name:'Preisstufe', unit:'(Stufe)', logic: 'Niedrig gewinnt', default: true } };
function getRandomDefaultAttributes() { const keys = Object.keys(attributeInfo); for (let i = keys.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [keys[i], keys[j]] = [keys[j], keys[i]]; } return keys.slice(0, 5); }
let activeAttributeKeys = getRandomDefaultAttributes();

const sounds={ flip:new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_139083c224.mp3'), win:new Audio('https://github.com/aufdemholzweg/holzquartett/blob/64126fed45ff8c3fb4bd833f473d83f51ba0548b/Sounds/spielzuggewonnen.mp3?raw=true'), quizTick: new Audio('https://github.com/aufdemholzweg/holzquartett/blob/main/Sounds/ticken_bei_quizfrage.mp3?raw=true'), tieAlert: new Audio('https://github.com/aufdemholzweg/holzquartett/blob/main/Sounds/Quiztime.mp3?raw=true') };
function playSound(a){ if(!isMuted && a){ a.currentTime=0; a.play().catch(()=>{}); } }

function isOpponentNameBackVisible(){ return localStorage.getItem('holzquartett_showOpponentNameOnBack')==='true'; }
function setOpponentNameBackVisible(v){ localStorage.setItem('holzquartett_showOpponentNameOnBack', v?'true':'false'); }

const IMG_BASE = "https://github.com/aufdemholzweg/holzquartett/blob/main/images"; const IMG_SUFFIX = "?raw=true";
const woodCards=[
 {name:"ğŸŒ³ Ahorn", dk:"5", druckfestigkeit:60, quellen:9, rohdichte:650, emodul:9500, preis:2, imgTree:`${IMG_BASE}/ahorn_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ahorn_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Birke", dk:"5", druckfestigkeit:50, quellen:11.7, rohdichte:650, emodul:14500, preis:2, imgTree:`${IMG_BASE}/birke_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/birke_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ² Douglasie", dk:"5", druckfestigkeit:70, quellen:7.5, rohdichte:500, emodul:13000, preis:4, imgTree:`${IMG_BASE}/douglasie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/douglasie_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Ebenholz, Afr.", dk:"1-2", druckfestigkeit:70, quellen:12.8, rohdichte:1200, emodul:13000, preis:5, imgTree:`${IMG_BASE}/ebenholz_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ebenholz_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Edelkastanie", dk:"2", druckfestigkeit:50, quellen:6.8, rohdichte:620, emodul:9000, preis:3, imgTree:`${IMG_BASE}/kastanie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kastanie_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ² Eibe", dk:"2", druckfestigkeit:60, quellen:5.2, rohdichte:670, emodul:15000, preis:4, imgTree:`${IMG_BASE}/eibe_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/eibe_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Eiche", dk:"2", druckfestigkeit:40, quellen:11.7, rohdichte:670, emodul:13000, preis:3, imgTree:`${IMG_BASE}/eiche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/eiche_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Erle", dk:"5", druckfestigkeit:55, quellen:9.4, rohdichte:550, emodul:9500, preis:1, imgTree:`${IMG_BASE}/erle_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/erle_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Esche", dk:"5", druckfestigkeit:50, quellen:8.5, rohdichte:670, emodul:13000, preis:2, imgTree:`${IMG_BASE}/esche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/esche_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ² Fichte", dk:"4", druckfestigkeit:50, quellen:8, rohdichte:480, emodul:11000, preis:2, imgTree:`${IMG_BASE}/fichte_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/fichte_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ² Hemlock", dk:"4", druckfestigkeit:55, quellen:8.5, rohdichte:480, emodul:10000, preis:4, imgTree:`${IMG_BASE}/hemlock_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/hemlock_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Hickory", dk:"4", druckfestigkeit:65, quellen:11, rohdichte:800, emodul:15000, preis:3, imgTree:`${IMG_BASE}/hickory_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/hickory_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ² Kiefer", dk:"3-4", druckfestigkeit:55, quellen:12.4, rohdichte:520, emodul:11000, preis:1, imgTree:`${IMG_BASE}/kiefer_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kiefer_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Kirschbaum", dk:"3", druckfestigkeit:55, quellen:8.5, rohdichte:630, emodul:10600, preis:3, imgTree:`${IMG_BASE}/kirsche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/kirsche_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ² LÃ¤rche", dk:"3-4", druckfestigkeit:55, quellen:10.4, rohdichte:590, emodul:13800, preis:3, imgTree:`${IMG_BASE}/laerche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/laerche_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Linde", dk:"5", druckfestigkeit:50, quellen:10.7, rohdichte:520, emodul:7200, preis:2, imgTree:`${IMG_BASE}/linde_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/linde_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Mahagoni (echtes)", dk:"2", druckfestigkeit:50, quellen:5.8, rohdichte:600, emodul:10600, preis:5, imgTree:`${IMG_BASE}/mahagoni_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/mahagoni_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Meranti (DR)", dk:"3-4", druckfestigkeit:65, quellen:9.8, rohdichte:720, emodul:14500, preis:4, imgTree:`${IMG_BASE}/meranti_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/meranti_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Nussbaum (EU)", dk:"3", druckfestigkeit:70, quellen:7.5, rohdichte:670, emodul:12000, preis:4, imgTree:`${IMG_BASE}/nuss_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/nuss_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Palisander", dk:"1", druckfestigkeit:80, quellen:8.1, rohdichte:850, emodul:12800, preis:5, imgTree:`${IMG_BASE}/palisander_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/palisander_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Pappel", dk:"5", druckfestigkeit:35, quellen:9.8, rohdichte:450, emodul:9000, preis:2, imgTree:`${IMG_BASE}/pappel_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/pappel_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Platane", dk:"5", druckfestigkeit:45, quellen:8.5, rohdichte:620, emodul:12800, preis:3, imgTree:`${IMG_BASE}/platane_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/platane_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ² Redwood", dk:"2", druckfestigkeit:40, quellen:5.2, rohdichte:400, emodul:9500, preis:2, imgTree:`${IMG_BASE}/redwood_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/redwood_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Robinie", dk:"1-2", druckfestigkeit:70, quellen:7.5, rohdichte:770, emodul:13600, preis:3, imgTree:`${IMG_BASE}/robinie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/robinie_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Kastanie", dk:"5", druckfestigkeit:30, quellen:6.8, rohdichte:550, emodul:6500, preis:3, imgTree:`${IMG_BASE}/rosskastanie_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/rosskastanie_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Rotbuche", dk:"5", druckfestigkeit:60, quellen:11.7, rohdichte:720, emodul:14000, preis:2, imgTree:`${IMG_BASE}/buche_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/buche_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ RÃ¼ster", dk:"4", druckfestigkeit:45, quellen:8.3, rohdichte:670, emodul:11000, preis:3, imgTree:`${IMG_BASE}/ulme_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/ulme_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ² Tanne", dk:"4", druckfestigkeit:45, quellen:7.5, rohdichte:450, emodul:11000, preis:2, imgTree:`${IMG_BASE}/tanne_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/tanne_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Teak", dk:"1", druckfestigkeit:60, quellen:5.8, rohdichte:670, emodul:13000, preis:5, imgTree:`${IMG_BASE}/teak_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/teak_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ WengÃ©", dk:"2", druckfestigkeit:90, quellen:9.4, rohdichte:850, emodul:16000, preis:4, imgTree:`${IMG_BASE}/wenge_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/wenge_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ³ Zebrano", dk:"2-3", druckfestigkeit:50, quellen:9, rohdichte:770, emodul:15400, preis:4, imgTree:`${IMG_BASE}/zebrano_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/zebrano_2.jpeg${IMG_SUFFIX}`},
 {name:"ğŸŒ² Zeder", dk:"1-2", druckfestigkeit:40, quellen:11, rohdichte:550, emodul:7200, preis:5, imgTree:`${IMG_BASE}/zeder_1.jpeg${IMG_SUFFIX}`, imgCross:`${IMG_BASE}/zeder_2.jpeg${IMG_SUFFIX}`}
];

const detailedWoodInfo = {
    "ğŸŒ³ Ahorn": `<div class="text-xs font-bold mb-2">ğŸŸ© Heimisch (Europa)</div><p class="mb-2">Das helle Holz glÃ¤nzt seidig und hat eine sehr gleichmÃ¤ÃŸige Struktur. Es ist hart und gleichzeitig elastisch.</p><p class="mb-2"><strong>Verwendung:</strong> Hochwertige MassivmÃ¶bel, Tischplatten, BÃ¶den von Streichinstrumenten.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Ahorn hat einen typischen <strong>Seidenglanz</strong> auf gehobelten FlÃ¤chen. Die Poren sind so fein, dass du sie mit bloÃŸem Auge nicht sehen kannst.</div>`,
    "ğŸŒ³ Birke": `<div class="text-xs font-bold mb-2">ğŸŸ© Heimisch (Europa, Nordasien)</div><p class="mb-2">Die Birke liefert ein helles, gelblich-weiÃŸes bis rÃ¶tliches Holz. Es ist mÃ¤ÃŸig hart und zÃ¤h, aber leider nicht witterungsbestÃ¤ndig.</p><p class="mb-2"><strong>Verwendung:</strong> Der Klassiker fÃ¼r Sperrholz und Multiplex-Platten.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Hier sind die GefÃ¤ÃŸe (Poren) oft breiter als die Markstrahlen. Im Querschnitt sehen die Poren aus wie <strong>feine, helle Punkte</strong>.</div>`,
    "ğŸŒ² Douglasie": `<div class="text-xs font-bold mb-2">ğŸŸ© Heimisch (EingebÃ¼rgert)</div><p class="mb-2">Ein Nadelholz mit einem krÃ¤ftigen, rÃ¶tlichen Kern. Es ist fester und widerstandsfÃ¤higer als Fichte und enthÃ¤lt Harz.</p><p class="mb-2"><strong>Verwendung:</strong> Konstruktionsholz fÃ¼r drauÃŸen, Terrassendielen.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Der Ãœbergang zwischen dem hellen FrÃ¼hholz und dem dunklen SpÃ¤tholz ist sehr scharf. Wenn du es bearbeitest, riecht es oft leicht nach <strong>Zitrone</strong>.</div>`,
    "ğŸŒ³ Ebenholz, Afr.": `<div class="text-xs font-bold mb-2 text-red-600">ğŸŸ¥ Import (Afrika) - Stark gefÃ¤hrdet</div><p class="mb-2">Dieses Holz ist extrem hart, schwer und dicht. Der Kern ist tiefschwarz. Es ist so fein, dass es sich hervorragend polieren lÃ¤sst.</p><p class="mb-2"><strong>Verwendung:</strong> Griffbretter fÃ¼r Geigen und Gitarren, Klaviertasten.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Es hat eine enorme Dichte und <strong>sinkt im Wasser</strong>. Die Poren sind oft mit dunklen Inhaltsstoffen gefÃ¼llt und kaum sichtbar.</div>`,
    "ğŸŒ³ Edelkastanie": `<div class="text-xs font-bold mb-2">ğŸŸ© Heimisch (SÃ¼deuropa)</div><p class="mb-2">Ein ringporiges Hartholz mit einem gelbbraunen Kern. Es sieht der Eiche zum Verwechseln Ã¤hnlich, ist aber etwas leichter und weicher.</p><p class="mb-2"><strong>Verwendung:</strong> Fassholz fÃ¼r Wein, PfÃ¤hle, MÃ¶bel.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Es sieht aus wie Eiche, aber es fehlen die breiten Markstrahlen. Du siehst also <strong>keine Spiegel</strong> auf der radialen FlÃ¤che.</div>`,
    "ğŸŒ² Eibe": `<div class="text-xs font-bold mb-2 text-yellow-600">ğŸŸ¨ Heimisch - GeschÃ¼tzt</div><p class="mb-2">Das hÃ¤rteste und schwerste Nadelholz, das wir haben. Der Kern ist rÃ¶tlich-violett. Es ist extrem zÃ¤h und dauerhaft.</p><p class="mb-2"><strong>Verwendung:</strong> Drechseln, Kunsttischlerei, Bogenbau.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Obwohl es ein Nadelholz ist, hat die Eibe <strong>keine HarzkanÃ¤le</strong>. Die Jahresringe verlaufen oft sehr wellig.</div>`,
    "ğŸŒ³ Eiche": `<div class="text-xs font-bold mb-2">ğŸŸ© Heimisch (Europa)</div><p class="mb-2">Der Klassiker. Der Kern ist graugelb bis gelbbraun. Das Holz ist hart, schwer und dank der GerbsÃ¤ure sehr wetterfest.</p><p class="mb-2"><strong>Verwendung:</strong> MassivholzmÃ¶bel, ParkettbÃ¶den, WeinfÃ¤sser.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Die Eiche erkennst du sofort an den breiten <strong>Markstrahlen</strong>. Im Radialschnitt glÃ¤nzen sie als auffÃ¤llige Spiegel.</div>`,
    "ğŸŒ³ Erle": `<div class="text-xs font-bold mb-2">ğŸŸ© Heimisch (Europa)</div><p class="mb-2">Frisch gefÃ¤llt leuchtet das Holz orange-rot. Es ist ein weiches und leichtes Laubholz.</p><p class="mb-2"><strong>Verwendung:</strong> Kirschbaum-Ersatz (gebeizt), Modellbau. Unter Wasser extrem haltbar.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Die Markstrahlen bÃ¼ndeln sich oft zu sogenannten <strong>Scheinmarkstrahlen</strong>, die du als LÃ¤ngsstreifen erkennen kannst.</div>`,
    "ğŸŒ³ Esche": `<div class="text-xs font-bold mb-2">ğŸŸ© Heimisch (Europa)</div><p class="mb-2">Ein ringporiges Hartholz. Es ist bekannt fÃ¼r seine extreme ZÃ¤higkeit und ElastizitÃ¤t.</p><p class="mb-2"><strong>Verwendung:</strong> Perfekt fÃ¼r Werkzeugstiele (HÃ¤mmer, Ã„xte) und SportgerÃ¤te.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Es ist ringporig wie die Eiche, besitzt aber <strong>keine breiten Markstrahlen</strong>.</div>`,
    "ğŸŒ² Fichte": `<div class="text-xs font-bold mb-2">ğŸŸ© Heimisch (Europa)</div><p class="mb-2">Das wichtigste Bauholz. Es ist hell, weich und leicht, aber fest genug fÃ¼r Tragwerke.</p><p class="mb-2"><strong>Verwendung:</strong> DachstÃ¼hle, LeimholztrÃ¤ger, MÃ¶bel.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Im Gegensatz zur Tanne hat die Fichte <strong>HarzkanÃ¤le</strong>. Die Ã„ste sind meist klein, schwarz und fest verwachsen.</div>`,
    "ğŸŒ² Hemlock": `<div class="text-xs font-bold mb-2 text-yellow-600">ğŸŸ¨ Import (Nordamerika)</div><p class="mb-2">Ein Nadelholz aus Nordamerika. Es ist grau-weiÃŸ bis gelblich und harzfrei.</p><p class="mb-2"><strong>Verwendung:</strong> Saunabau (harzt nicht), Innenausbau.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Es sieht der Fichte Ã¤hnlich, ist aber eher <strong>grau im Farbton</strong> und besitzt absolut keine HarzkanÃ¤le.</div>`,
    "ğŸŒ³ Hickory": `<div class="text-xs font-bold mb-2 text-yellow-600">ğŸŸ¨ Import (Nordamerika)</div><p class="mb-2">Ein sehr hartes Holz aus der Walnuss-Familie. HÃ¶chste ZÃ¤higkeit aller HandelshÃ¶lzer.</p><p class="mb-2"><strong>Verwendung:</strong> Hochwertige Werkzeugstiele, Drumsticks.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Im dunklen SpÃ¤tholz kannst du feine, helle Linien erkennen. Das sind netzartige <strong>ParenchymbÃ¤nder</strong>.</div>`,
    "ğŸŒ³ Kastanie": `<div class="text-xs font-bold mb-2">ğŸŸ© Heimisch (Europa)</div><p class="mb-2">Das Holz ist weiÃŸlich bis gelblich und weich. Es hat eine sehr homogene Struktur.</p><p class="mb-2"><strong>Verwendung:</strong> Blindholz, Schnitzereien, Kisten.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Die Markstrahlen sind stockwerkartig angeordnet. Das erzeugt auf der FlÃ¤che eine sehr feine <strong>Rippelung</strong> (Ripple Marks).</div>`,
    "ğŸŒ² Kiefer": `<div class="text-xs font-bold mb-2">ğŸŸ© Heimisch (Europa)</div><p class="mb-2">Starker Kontrast zwischen dem rÃ¶tlichen Kern und dem gelben Splint. Harzreich.</p><p class="mb-2"><strong>Verwendung:</strong> Fenster, TÃ¼ren, MÃ¶bel im Landhausstil, Dielen.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Auf dem Querschnitt siehst du groÃŸe, deutliche <strong>HarzkanÃ¤le</strong>. Riecht intensiv nach Harz.</div>`,
    "ğŸŒ³ Kirschbaum": `<div class="text-xs font-bold mb-2">ğŸŸ© Heimisch (Europa)</div><p class="mb-2">Ein edles, feinporiges Hartholz. Der Kern ist rÃ¶tlich und dunkelt feurig nach.</p><p class="mb-2"><strong>Verwendung:</strong> StilmÃ¶bel, Innenausbau.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Die Markstrahlen erscheinen im Querschnitt als helle, <strong>scharf begrenzte Linien</strong>.</div>`,
    "ğŸŒ² LÃ¤rche": `<div class="text-xs font-bold mb-2">ğŸŸ© Heimisch (Europa)</div><p class="mb-2">Schwerstes heimisches Nadelholz. Kern intensiv rotbraun. Sehr witterungsbestÃ¤ndig.</p><p class="mb-2"><strong>Verwendung:</strong> Fassaden, Fenster, BrÃ¼cken, AuÃŸenbereich.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Der Ãœbergang vom hellen FrÃ¼hholz zum dunklen <strong>SpÃ¤tholz</strong> ist extrem scharf und kontrastreich.</div>`,
    "ğŸŒ³ Linde": `<div class="text-xs font-bold mb-2">ğŸŸ© Heimisch (Europa)</div><p class="mb-2">Ein helles, weiches und leichtes Holz. Kaum sichtbare Jahresringe.</p><p class="mb-2"><strong>Verwendung:</strong> Das klassische Holz fÃ¼r Bildhauer und Schnitzer.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Das Holz ist in alle Richtungen <strong>sehr homogen</strong> schneidbar (ideal zum Schnitzen).</div>`,
    "ğŸŒ³ Mahagoni (echtes)": `<div class="text-xs font-bold mb-2 text-red-600">ğŸŸ¥ Import (Tropen) - CITES!</div><p class="mb-2">Tropisches Kernholz, rotbraun bis kupferrot. MÃ¤ÃŸig hart, arbeitet kaum.</p><p class="mb-2"><strong>Verwendung:</strong> Exklusive MÃ¶bel, Bootsbau.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Durch den <strong>Wechseldrehwuchs</strong> entstehen auf der FlÃ¤che die berÃ¼hmten Hell-Dunkel-Streifen.</div>`,
    "ğŸŒ³ Meranti (DR)": `<div class="text-xs font-bold mb-2 text-yellow-600">ğŸŸ¨ Import (Asien)</div><p class="mb-2">DR steht fÃ¼r <strong>Dark Red</strong>. Der Kern ist rotbraun. Eigenschaften schwanken stark.</p><p class="mb-2"><strong>Verwendung:</strong> Fensterbau (Standard), AuÃŸentÃ¼ren.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Grobporig. Auf dem Querschnitt sieht man oft feine weiÃŸe Linien mit Harz (<strong>Gummiadern</strong>).</div>`,
    "ğŸŒ³ Nussbaum (EU)": `<div class="text-xs font-bold mb-2">ğŸŸ© Heimisch (Europa)</div><p class="mb-2">Sehr dekoratives Hartholz. Kern grau-braun, oft dunkel gemasert.</p><p class="mb-2"><strong>Verwendung:</strong> Teure MÃ¶bel, Furniere, GewehrschÃ¤fte.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Es ist <strong>halbringporig</strong>. Die Poren werden vom FrÃ¼hjahr zum Sommer hin langsam kleiner.</div>`,
    "ğŸŒ³ Palisander": `<div class="text-xs font-bold mb-2 text-red-600">ğŸŸ¥ Import (Tropen) - CITES!</div><p class="mb-2">Sehr schweres, hartes Tropenholz. Violett bis schokobraun mit fast schwarzen Streifen.</p><p class="mb-2"><strong>Verwendung:</strong> Marimbaphone, Gitarren, Luxusobjekte.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Charakteristisch sind die <strong>schwarzen Farbstreifen</strong>. Riecht sÃ¼ÃŸlich bei Bearbeitung.</div>`,
    "ğŸŒ³ Pappel": `<div class="text-xs font-bold mb-2">ğŸŸ© Heimisch (Europa)</div><p class="mb-2">Sehr weiches und leichtes Laubholz. Grau-weiÃŸ bis brÃ¤unlich.</p><p class="mb-2"><strong>Verwendung:</strong> Paletten, ZÃ¼ndhÃ¶lzer, SaunabÃ¤nke.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Nach dem SÃ¤gen ist die OberflÃ¤che sehr <strong>wollig und faserig</strong>.</div>`,
    "ğŸŒ³ Platane": `<div class="text-xs font-bold mb-2">ğŸŸ© Heimisch (SÃ¼deuropa)</div><p class="mb-2">Zerstreutporiges Laubholz mit rÃ¶tlichem Kern. MÃ¤ÃŸig hart.</p><p class="mb-2"><strong>Verwendung:</strong> Innenausbau, Drechseln.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Die Markstrahlen sind ungewÃ¶hnlich <strong>breit und hoch</strong> (Perlholz-Optik im Schnitt).</div>`,
    "ğŸŒ² Redwood": `<div class="text-xs font-bold mb-2 text-yellow-600">ğŸŸ¨ Import (USA)</div><p class="mb-2">Mammutbaum-Holz. Rotbraun, sehr leicht und weich, aber dauerhaft.</p><p class="mb-2"><strong>Verwendung:</strong> Fassaden, Schindeln.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Ã„hnelt LÃ¤rche, hat aber <strong>keine HarzkanÃ¤le</strong> und eine sehr grobe Struktur.</div>`,
    "ğŸŒ³ Robinie": `<div class="text-xs font-bold mb-2">ğŸŸ© Heimisch (EingebÃ¼rgert)</div><p class="mb-2">Kern olivgrÃ¼n bis goldbraun. Extrem hart, zÃ¤h und dauerhaft.</p><p class="mb-2"><strong>Verwendung:</strong> SpielplÃ¤tze, GartenmÃ¶bel, PfÃ¤hle.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Die groÃŸen FrÃ¼hholzporen sind komplett mit <strong>Thyllen</strong> verstopft.</div>`,
    "ğŸŒ³ Rotbuche": `<div class="text-xs font-bold mb-2">ğŸŸ© Heimisch (Europa)</div><p class="mb-2">Schlichtes, rÃ¶tlich-weiÃŸes Holz. Hart und schwer, arbeitet aber stark.</p><p class="mb-2"><strong>Verwendung:</strong> StÃ¼hle (Bugholz), WerkbÃ¤nke, Treppen.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Markstrahlen im Tangentialschnitt als dunkle Spindeln (<strong>Reiskerne</strong>) sichtbar.</div>`,
    "ğŸŒ³ RÃ¼ster": `<div class="text-xs font-bold mb-2">ğŸŸ© Heimisch (Europa)</div><p class="mb-2">Holz der Ulme. Ringporig, schokobrauner Kern. Sehr zÃ¤h.</p><p class="mb-2"><strong>Verwendung:</strong> MÃ¶bel, Treppen, SportgerÃ¤te.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Feine Poren im SpÃ¤tholz bilden wellenfÃ¶rmige BÃ¤nder (<strong>Ulmenwellen</strong>).</div>`,
    "ğŸŒ² Tanne": `<div class="text-xs font-bold mb-2">ğŸŸ© Heimisch (Europa)</div><p class="mb-2">Helles Nadelholz ohne Farbkern. Harzfrei.</p><p class="mb-2"><strong>Verwendung:</strong> Konstruktion, Fenster, Innenausbau.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Im Gegensatz zur Fichte hat die Tanne absolut <strong>keine HarzkanÃ¤le</strong>.</div>`,
    "ğŸŒ³ Teak": `<div class="text-xs font-bold mb-2 text-yellow-600">ğŸŸ¨ Import (Asien)</div><p class="mb-2">Goldbraun, fÃ¼hlt sich Ã¶lig an. Extrem wetterfest.</p><p class="mb-2"><strong>Verwendung:</strong> Schiffsdecks, GartenmÃ¶bel.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>FÃ¼hlt sich <strong>wachsig</strong> an und riecht wie altes Leder.</div>`,
    "ğŸŒ³ WengÃ©": `<div class="text-xs font-bold mb-2 text-red-600">ğŸŸ¥ Import (Afrika) - GefÃ¤hrdet</div><p class="mb-2">Fast schwarz mit feinen hellen Streifen. Sehr hart, splittert leicht.</p><p class="mb-2"><strong>Verwendung:</strong> Exklusive ParkettbÃ¶den, MÃ¶bel.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Helle Speicherzellen erzeugen auf der FlÃ¤che ein feines <strong>Rebhuhn-Muster</strong>.</div>`,
    "ğŸŒ³ Zebrano": `<div class="text-xs font-bold mb-2 text-red-600">ğŸŸ¥ Import (Afrika) - GefÃ¤hrdet</div><p class="mb-2">Hellbraun mit regelmÃ¤ÃŸigen dunkelbraunen Streifen.</p><p class="mb-2"><strong>Verwendung:</strong> Furniere, Auto-Interieur.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Die <strong>Zebra-Streifung</strong> ist unverwechselbar. Riecht unangenehm.</div>`,
    "ğŸŒ² Zeder": `<div class="text-xs font-bold mb-2 text-yellow-600">ğŸŸ¨ Import (Nordamerika)</div><p class="mb-2">Meist Western Red Cedar. Sehr leicht, weich, rÃ¶tlich und haltbar.</p><p class="mb-2"><strong>Verwendung:</strong> Schindeln, Fassaden, Mottenkugeln.</p><div class="bg-amber-50 p-2 rounded border border-amber-200 mt-2"><strong>ğŸ” Hammermerkmal:</strong><br>Intensiver, <strong>aromatischer Geruch</strong> (Bleistift).</div>`
};

let usedQuizIndices = [];
function getUniqueQuizQuestionIndex() {
    if (usedQuizIndices.length === quizQuestions.length) usedQuizIndices = [];
    let idx;
    do { idx = Math.floor(Math.random() * quizQuestions.length); } while (usedQuizIndices.includes(idx));
    usedQuizIndices.push(idx);
    return idx;
}

function startTieBreakerQuiz(qIndex, callback) {
    const modal = document.getElementById('quizModal');
    const timerBar = document.getElementById('quizTimerBar');
    const qText = document.getElementById('quizQuestion');
    const qOptions = document.getElementById('quizOptions');
    const statusText = document.getElementById('quizStatusText');
    const expBox = document.getElementById('quizExplanation');
    
    const question = quizQuestions[qIndex];
    qText.innerText = question.q;
    qOptions.innerHTML = '';
    statusText.innerText = "âš ï¸ Gleichstand! Quiz lÃ¤dt...";
    expBox.classList.add('hidden'); 
    
    timerBar.classList.remove('animate-charge', 'animate-shrink');
    timerBar.style.width = "0%";
    timerBar.className = "h-full bg-amber-500 rounded-r-sm relative";
    void timerBar.offsetWidth;
    
    let buttons = [];
    question.o.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = "w-full bg-gray-100 text-gray-400 font-semibold py-3 px-4 rounded-lg border-2 border-gray-200 cursor-not-allowed";
        btn.innerText = opt;
        btn.disabled = true; 
        buttons.push({btn, idx});
        qOptions.appendChild(btn);
    });
    
    modal.classList.remove('hidden');
    timerBar.classList.add('animate-charge');
    
    setTimeout(() => {
        statusText.innerText = "âš¡ STECHEN! 10 Sekunden Zeit";
        timerBar.classList.remove('animate-charge');
        timerBar.style.width = '100%';
        void timerBar.offsetWidth;
        timerBar.className = "h-full bg-red-500 rounded-r-sm relative animate-shrink";
        playSound(sounds.quizTick);
        
        let answered = false;
        buttons.forEach(obj => {
            const {btn, idx} = obj;
            btn.className = "w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-lg border-2 border-gray-200 transition active:scale-95 cursor-pointer";
            btn.disabled = false;
            btn.onclick = () => {
                if(answered) return;
                answered = true;
                clearTimeout(quizTimeout);
                sounds.quizTick.pause(); sounds.quizTick.currentTime = 0;
                const explanation = question.e || "Keine ErklÃ¤rung verfÃ¼gbar.";
                expBox.innerText = "ğŸ’¡ " + explanation;
                expBox.classList.remove('hidden');
                if(idx === question.c) {
                    btn.className = "w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg border-2 border-green-600 shadow-lg scale-105";
                    playSound(sounds.win);
                    setTimeout(() => { modal.classList.add('hidden'); callback('correct'); }, 4500);
                } else {
                    btn.className = "w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg border-2 border-red-600 shadow-md transform scale-95 opacity-50";
                    const correctBtnObj = buttons.find(b => b.idx === question.c);
                    if(correctBtnObj) correctBtnObj.btn.className = "w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg border-2 border-green-600 shadow-lg scale-105 animate-pulse";
                    setTimeout(() => { modal.classList.add('hidden'); callback('wrong'); }, 4500);
                }
            };
        });
        const quizTimeout = setTimeout(() => {
            if(!answered) {
                answered = true;
                sounds.quizTick.pause(); sounds.quizTick.currentTime = 0;
                modal.classList.add('hidden');
                callback('timeout');
            }
        }, 10000);
    }, 1500);
}

function showTieOverlay(callback) {
    const overlay = document.getElementById('tieOverlay');
    overlay.classList.remove('hidden');
    playSound(sounds.tieAlert);
    setTimeout(() => {
        overlay.classList.add('hidden');
        if(callback) callback();
    }, 2000);
}

function evaluateRoundAI(attr){
    const rawPv = aiGame.currentPlayerCard[attr];
    const rawAv = aiGame.currentAiCard[attr];
    const pv = getNumericValue(rawPv, attr);
    const av = getNumericValue(rawAv, attr);
    const logic = attributeInfo[attr].logic;
    let pWins = (logic === 'Niedrig gewinnt') ? (pv < av) : (pv > av);
    if(pv === av) {
        showTieOverlay(() => {
            const qIdx = getUniqueQuizQuestionIndex();
            startTieBreakerQuiz(qIdx, (result) => {
                let roundWinner = false;
                if(result === 'correct') roundWinner = true;
                finishRoundAI(attr, rawPv, rawAv, roundWinner);
            });
        });
        return;
    }
    finishRoundAI(attr, rawPv, rawAv, pWins);
}

function finishRoundAI(attr, rawPv, rawAv, pWins) {
    const resText = pWins===true ? 'Du gewinnst!' : 'Computer gewinnt!';
    const resColor = pWins===true ? 'text-green-600' : 'text-red-600';
    document.getElementById('resultText').innerText = resText;
    document.getElementById('resultText').className = `text-2xl font-black uppercase tracking-wide mb-2 ${resColor}`;
    document.getElementById('resultDetails').innerText = `${attributeInfo[attr].name}: ${rawPv} vs ${rawAv}`;
    if(pWins===true) { playSound(sounds.win); showHappyWorm(); lastRoundWinningWoodName = aiGame.currentPlayerCard.name; } 
    else { lastRoundWinningWoodName = aiGame.currentAiCard.name; }
    openBottomSheet(resText);
    const pC=aiGame.playerCards.shift(); const aC=aiGame.aiCards.shift();
    if(pWins===true){ aiGame.playerCards.push(pC, aC); aiGame.turn='player'; }
    else { aiGame.aiCards.push(aC, pC); aiGame.turn='ai'; }
    if(aiGame.playerCards.length===0) window.endGame("Computer");
    if(aiGame.aiCards.length===0) window.endGame(aiGame.playerName);
}

function aiTurn(){
    if(aiGame.roundInProgress) return;
    scrollToTop();
    const k=activeAttributeKeys[Math.floor(Math.random()*activeAttributeKeys.length)];
    aiGame.roundInProgress = true;
    const aiCardEl = document.getElementById('aiCard');
    const row = aiCardEl.querySelector(`div[data-attr-row="${k}"]`);
    if(row) row.classList.add('flash-active'); 
    setTimeout(() => { 
        const ac=document.getElementById('aiCard').querySelector('.card-3d');
        if(ac){ ac.classList.remove('card-flipped'); playSound(sounds.flip); }
        const playerCardEl = document.getElementById('playerCard');
        const pRow = playerCardEl.querySelector(`div[data-attr-btn="${k}"]`) || playerCardEl.querySelector(`div[data-attr-row="${k}"]`);
        if(pRow) pRow.classList.add('highlight-compare');
        setTimeout(() => evaluateRoundAI(k), 2000);
    }, 500);
}

function listenToGameChanges(){
    if(!gameId) return;
    unsubscribeGame=onSnapshot(getPublicDataRef("games", gameId),(ds)=>{
        if(!ds.exists()) { window.resetGame(); return; }
        const gd=ds.data(); localGameState=gd;
        if(gd.activeAttributes) { activeAttributeKeys = gd.activeAttributes; }
        
        if(gd.quizTrigger && gd.quizTrigger.active && !document.getElementById('quizModal').dataset.active) {
             document.getElementById('quizModal').dataset.active = "true";
             showTieOverlay(() => {
                 startTieBreakerQuiz(gd.quizTrigger.qIndex, async (result) => {
                     document.getElementById('quizModal').dataset.active = "";
                     const opp = localGameState.playerIds.find(id=>id!==localPlayerId);
                     let winner = 'tie';
                     if (result === 'correct') { winner = localPlayerId; } else if (result === 'wrong') { winner = opp; } 
                     const rawPv = localGameState.currentCards[localPlayerId][gd.quizTrigger.attr];
                     const rawOv = localGameState.currentCards[opp][gd.quizTrigger.attr];
                     await updateDoc(getPublicDataRef("games", gameId),{
                        quizTrigger: null,
                        lastResult: {winnerId:winner, attribute:gd.quizTrigger.attr, values:{[localPlayerId]:rawPv, [opp]:rawOv}}
                     });
                 });
             });
        }
        
        if((!gd.quizTrigger || !gd.quizTrigger.active) && document.getElementById('quizModal').classList.contains('hidden') === false) {
             document.getElementById('quizModal').classList.add('hidden');
             document.getElementById('quizModal').dataset.active = "";
             sounds.quizTick.pause(); sounds.quizTick.currentTime = 0;
        }

        if(gd.status==='playing'||gd.status==='finished'){
            document.getElementById('multiplayerLobbyModal').classList.add('hidden');
            document.getElementById('gameContainer').classList.remove('hidden');
            document.getElementById('ruleButton').classList.remove('hidden');
            if(!gd.quizTrigger) scrollToTop();
            const oppId=gd.playerIds.find(id=>id!==localPlayerId);
            document.getElementById('playerNameDisplay').innerText = gd.players[localPlayerId]?.name || 'DU';
            document.getElementById('opponentNameDisplay').innerText = (oppId ? gd.players[oppId]?.name : 'GEGNER').toUpperCase();
            const pCount = gd.players[localPlayerId]?.cards?.length||0;
            const oCount = oppId ? (gd.players[oppId]?.cards?.length||0) : 0;
            document.getElementById('playerCards').innerText = pCount;
            document.getElementById('aiCards').innerText = oCount;
            updateStatusBar(pCount, oCount);
            const highlightAttr = gd.lastResult ? gd.lastResult.attribute : null;
            const pc = document.getElementById('playerCard'); const ac = document.getElementById('aiCard');
            pc.innerHTML=''; ac.innerHTML='';
            const isPlayerTurn = gd.turn === localPlayerId;
            if(gd.currentCards[localPlayerId]) pc.appendChild(createCard(gd.currentCards[localPlayerId], true, true, isPlayerTurn, highlightAttr));
            if(oppId && gd.currentCards[oppId]){
                const c = createCard(gd.currentCards[oppId], false, false, !isPlayerTurn, highlightAttr);
                ac.appendChild(c);
                if(gd.lastResult){ setTimeout(()=> { c.classList.remove('card-flipped'); playSound(sounds.flip); }, 100); }
            } else { ac.innerHTML = `<div class="w-full h-full bg-gray-200 rounded-2xl flex items-center justify-center text-xs text-gray-500">Warte auf Gegner-Karte...</div>`; }
            
            if(gd.lastResult){
                 const wId = gd.lastResult.winnerId;
                 const iWin = wId===localPlayerId;
                 if(gd.currentCards[wId]) { lastRoundWinningWoodName = gd.currentCards[wId].name; }
                 if(!roundSoundPlayed && iWin) playSound(sounds.win);
                 roundSoundPlayed=true;
                 const resText = iWin ? 'Du gewinnst!' : (wId==='tie'?'Unentschieden':'Gegner gewinnt!');
                 document.getElementById('resultText').className = iWin ? 'text-2xl font-black uppercase text-green-600' : 'text-2xl font-black uppercase text-red-600';
                 document.getElementById('resultDetails').innerText = `${attributeInfo[gd.lastResult.attribute].name}: ${gd.lastResult.values[localPlayerId]} vs ${gd.lastResult.values[oppId]}`;
                 if(iWin) showHappyWorm();
                 if(document.getElementById('bottomSheet').classList.contains('hidden')) openBottomSheet(resText);
            } else { roundSoundPlayed=false; closeBottomSheet(); }
            document.getElementById('turnIndicator').innerText = (gd.turn===localPlayerId) ? "Du bist am Zug!" : "Gegner wÃ¤hlt...";
            if(gd.status==='finished'){
                let winnerName = "";
                if (gd.players[localPlayerId].cards.length > 0) winnerName = gd.players[localPlayerId].name;
                else if (oppId && gd.players[oppId].cards.length > 0) winnerName = gd.players[oppId].name;
                window.endGame(winnerName);
            }
        }
    });
}

window.selectAttribute = async (attr) => {
    if(gameMode==='ai') {
        if(aiGame.roundInProgress) return;
        scrollToTop();
        aiGame.roundInProgress = true;
        const btn = document.querySelector(`div[data-attr-btn="${attr}"]`); if(btn) btn.classList.add('flash-active');
        setTimeout(() => {
            const ac=document.getElementById('aiCard').querySelector('.card-3d');
            if(ac){ ac.classList.remove('card-flipped'); playSound(sounds.flip); }
            const oppRow = document.getElementById('aiCard').querySelector(`div[data-attr-row="${attr}"]`);
            if(oppRow) oppRow.classList.add('highlight-compare');
            setTimeout(() => evaluateRoundAI(attr), 2000);
        }, 500);
    } else {
        if(!localGameState || localGameState.turn!==localPlayerId) return;
        scrollToTop();
        const opp = localGameState.playerIds.find(id=>id!==localPlayerId);
        const rawPv = localGameState.currentCards[localPlayerId][attr];
        const rawOv = localGameState.currentCards[opp][attr];
        const pv = getNumericValue(rawPv, attr);
        const ov = getNumericValue(rawOv, attr);
        const logic = attributeInfo[attr].logic;
        let pWins = (logic === 'Niedrig gewinnt') ? (pv < ov) : (pv > ov);
        
        if(pv === ov) {
            const qIdx = getUniqueQuizQuestionIndex();
            await updateDoc(getPublicDataRef("games", gameId),{
                quizTrigger: { active: true, attr: attr, qIndex: qIdx, timestamp: Date.now() }
            });
            return; 
        }
        const winner = pWins ? localPlayerId : opp;
        await updateDoc(getPublicDataRef("games", gameId),{
            lastResult: {winnerId:winner, attribute:attr, values:{[localPlayerId]:rawPv, [opp]:rawOv}}
        });
    }
};

window.startGameAI = (name) => {
    trackEvent('games_ai');
    gameMode='ai'; aiGame.playerName=name;
    window.setNavState('game');
    document.getElementById('ruleButton').classList.remove('hidden');
    document.getElementById('playerNameDisplay').innerText=name;
    const sh=shuffleArray([...woodCards]);
    aiGame.playerCards=sh.slice(0,15); aiGame.aiCards=sh.slice(15,30);
    aiGame.currentPlayerCard=aiGame.playerCards[0]; aiGame.currentAiCard=aiGame.aiCards[0];
    document.getElementById('gameContainer').classList.remove('hidden');
    scrollToTop();
    updateDisplayAI();
};

let authRetries = 0;
window.createGame = async (playerName) => {
    if (!auth || !auth.currentUser) { 
        if(authRetries > 10) { alert("Verbindungsfehler"); return; }
        authRetries++; setTimeout(() => window.createGame(playerName), 500); return; 
    }
    localPlayerId = auth.currentUser.uid;
    trackEvent('games_multiplayer');
    gameMode='multiplayer';
    const lobby=document.getElementById('multiplayerLobbyModal'); lobby.classList.remove('hidden');
    gameId=Math.random().toString(36).substring(2,8).toUpperCase();
    const joinUrl=`${window.location.href.split('?')[0]}?game=${gameId}`;
    document.getElementById('shareLink').value=joinUrl;
    document.getElementById('qrcode').innerHTML = "";
    new QRCode(document.getElementById('qrcode'), {text: joinUrl, width: 128, height: 128});
    
    await setDoc(getPublicDataRef("games", gameId),{
        gameId, status:'waiting', playerIds:[localPlayerId],
        players:{[localPlayerId]:{name:playerName,cards:[],status:'online'}},
        activeAttributes: activeAttributeKeys,
        createdAt:serverTimestamp()
    });
    listenToGameChanges();
};

window.joinGame = async (id, playerName) => {
    if (!auth || !auth.currentUser) { setTimeout(()=>window.joinGame(id,playerName), 500); return; }
    localPlayerId = auth.currentUser.uid;
    gameMode='multiplayer'; gameId = id;
    const ref = getPublicDataRef("games", id);
    const snap = await getDoc(ref);
    if(snap.exists() && snap.data().status==='waiting'){
        document.getElementById('lobbyTitle').textContent="Verbinde...";
        document.getElementById('multiplayerLobbyModal').classList.remove('hidden');
        const sh=shuffleArray([...woodCards]);
        const p1=snap.data().playerIds[0];
        await updateDoc(ref,{
            status:'playing', playerIds:[p1,localPlayerId],
            [`players.${localPlayerId}`]:{name:playerName,cards:sh.slice(15,30),status:'online'},
            [`players.${p1}.cards`]:sh.slice(0,15),
            turn:p1, currentCards:{[p1]:sh.slice(0,15)[0],[localPlayerId]:sh.slice(15,30)[0]},
            lastResult:null
        });
        scrollToTop();
        window.setNavState('game');
        listenToGameChanges();
    } else {
        alert("Spiel nicht gefunden oder voll.");
        window.location.href = window.location.href.split('?')[0];
    }
};

window.nextRound = async () => {
    scrollToTop();
    if(gameMode==='ai'){
        aiGame.currentPlayerCard=aiGame.playerCards[0];
        aiGame.currentAiCard=aiGame.aiCards[0];
        aiGame.roundInProgress=false;
        updateDisplayAI();
    } else {
        const gs = localGameState;
        const [p1,p2] = gs.playerIds;
        let c1=gs.players[p1].cards.shift();
        let c2=gs.players[p2].cards.shift();
        const w = gs.lastResult.winnerId;
        if(w===p1){ if(c1) gs.players[p1].cards.push(c1); if(c2) gs.players[p1].cards.push(c2); }
        else if(w===p2){ if(c1) gs.players[p2].cards.push(c1); if(c2) gs.players[p2].cards.push(c2); }
        else { if(c1) gs.players[p1].cards.push(c1); if(c2) gs.players[p2].cards.push(c2); }
        if(gs.players[p1].cards.length===0 || gs.players[p2].cards.length===0){
            await updateDoc(getPublicDataRef("games", gameId), {status:'finished', players:gs.players});
            return;
        }
        const nextT = w==='tie' ? gs.turn : w;
        await updateDoc(getPublicDataRef("games", gameId), {
            lastResult:null, turn:nextT, players:gs.players,
            currentCards:{[p1]:gs.players[p1].cards[0], [p2]:gs.players[p2].cards[0]}
        });
    }
};

window.showFinalWinScreen = () => { document.getElementById('reflectionModal').classList.add('hidden'); };

const calculateRank = (count) => {
    if (count >= 100) return { title: "Leim-Legende", stars: 6 };
    if (count >= 50) return { title: "Astloch-Philosoph", stars: 5 };
    if (count >= 30) return { title: "Brett-Bezwinger", stars: 4 };
    if (count >= 20) return { title: "Hobel-Held", stars: 3 };
    if (count >= 10) return { title: "Schleifklotz-Schwinger", stars: 2 };
    return { title: "Werkstatt-Neuling", stars: 1 };
};

async function updateMainMenuStats(user) {
    if (!user) return;
    const statsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'gamification', 'stats');
    try {
        const snap = await getDoc(statsRef);
        const count = snap.exists() ? (snap.data().gamesPlayed || 0) : 0;
        const rank = calculateRank(count);
        const container = document.getElementById('mainMenuStats');
        if(container) {
            container.innerHTML = `<div class="flex flex-col items-center gap-1"><div class="text-xs text-white/80 font-bold uppercase tracking-wider">Dein Rang</div><div class="flex items-center gap-2"><span class="text-xl font-bold text-white drop-shadow-md">${rank.title}</span><div class="flex text-amber-400 text-sm drop-shadow-sm">${Array(rank.stars).fill('â˜…').join('')}</div></div><div class="flex items-center gap-2 mt-1"><span class="text-lg filter drop-shadow">ğŸ”¥</span><span class="font-bold text-white text-lg drop-shadow-md">${count} Spiele</span></div></div>`;
            container.classList.remove('hidden');
        }
    } catch (e) {}
}
onAuthStateChanged(auth, (user) => { if (user) updateMainMenuStats(user); });

async function updateLeaderboard(name) {
    if (!auth.currentUser) return;
    const ref = getPublicDataRef("leaderboard", auth.currentUser.uid);
    try {
        await setDoc(ref, { name: name, wins: increment(1), last_win: serverTimestamp() }, { merge: true });
    } catch (e) {}
}

window.endGame = async (winnerName) => {
    document.getElementById('gameContainer').classList.add('hidden');
    document.getElementById('bottomSheet').classList.add('hidden');
    document.getElementById('bottomSheetBackdrop').classList.add('hidden');
    const isWin = (winnerName === (gameMode === 'ai' ? aiGame.playerName : localGameState.players[localPlayerId].name));
    const gameOverImg = document.getElementById('gameOverWorm');
    if(gameOverImg) { gameOverImg.src = isWin ? "https://github.com/aufdemholzweg/holzquartett/blob/main/images/klotzi_win.png?raw=true" : "https://github.com/aufdemholzweg/holzquartett/blob/main/images/klotzi_lose.png?raw=true"; }
    let newGamesCount = 0; let rankData = null;
    if (auth.currentUser) {
        const statsRef = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'gamification', 'stats');
        try {
            await setDoc(statsRef, { gamesPlayed: increment(1), lastPlayed: serverTimestamp() }, { merge: true });
            const snap = await getDoc(statsRef);
            newGamesCount = snap.data().gamesPlayed || 0;
            rankData = calculateRank(newGamesCount);
        } catch (e) {}
        if (isWin) { await updateLeaderboard(gameMode === 'ai' ? aiGame.playerName : localGameState.players[localPlayerId].name); }
    }
    const title = document.getElementById('gameOverTitle');
    const text = document.getElementById('gameOverText');
    if (isWin) {
        title.innerText = "GEWONNEN!";
        title.className = "text-3xl font-black mb-2 text-green-600";
        text.innerHTML = `Herzlichen GlÃ¼ckwunsch! Du hast gewonnen.<br><br><div class="flex items-center justify-center gap-2 text-amber-600 font-bold bg-amber-50 p-2 rounded-lg"><span class="text-2xl">ğŸ”¥</span> ${newGamesCount} Flammen gesammelt</div><div class="mt-2 text-sm text-gray-500">${rankData ? 'Rang: ' + rankData.title : ''}</div>`;
        triggerConfetti();
    } else {
        title.innerText = "VERLOREN";
        title.className = "text-3xl font-black mb-2 text-gray-600";
        text.innerHTML = `Schade, ${winnerName} hat gewonnen.<br>Dranbleiben lohnt sich!<br><br><div class="flex items-center justify-center gap-2 text-amber-600 font-bold bg-amber-50 p-2 rounded-lg"><span class="text-2xl">ğŸ”¥</span> ${newGamesCount} Flammen gesammelt</div><div class="mt-2 text-sm text-gray-500">${rankData ? 'Rang: ' + rankData.title : ''}</div>`;
    }
    document.getElementById('gameOverModal').classList.remove('hidden');
};

window.showLeaderboard = async () => { 
    const list=document.getElementById('leaderboardList');
    list.innerHTML='<div class="text-center py-4 text-gray-500">Lade...</div>';
    document.getElementById('gameOverModal').classList.add('hidden');
    document.getElementById('leaderboardModal').classList.remove('hidden');
    try {
        const q=query(getPublicDataRef("leaderboard"), orderBy("wins","desc"), limit(10));
        const snap=await getDocs(q);
        if(snap.empty){ list.innerHTML='<div class="text-center py-4 text-gray-400">Keine EintrÃ¤ge</div>'; return; }
        list.innerHTML = snap.docs.map((d,i)=>`<div class="flex justify-between p-3 rounded-lg ${i%2===0?'bg-gray-50':'bg-white'} border border-gray-100"><span class="font-bold text-gray-700">${i+1}. ${d.data().name}</span><span class="font-bold text-amber-600">${d.data().wins} ğŸ†</span></div>`).join('');
    } catch(e){ list.innerHTML='<div class="text-center text-red-400 text-sm">Fehler beim Laden</div>'; }
};

window.showNamePrompt = (mode) => {
    document.getElementById('setupModal').classList.add('hidden');
    document.getElementById('nameModal').classList.remove('hidden');
    const btn=document.getElementById('nameSubmitButton');
    const clone=btn.cloneNode(true);
    btn.parentNode.replaceChild(clone,btn);
    window.setNavState('name_input');
    clone.addEventListener('click',()=>{
        const n=document.getElementById('playerName').value.trim();
        if(!n)return;
        document.getElementById('nameModal').classList.add('hidden');
        if(mode==='ai') window.startGameAI(n);
        else if(mode==='multiplayer') window.createGame(n);
        else if(mode==='join') window.joinGame(gameId, n); 
    });
};
window.copyShareLink = () => { const l=document.getElementById('shareLink'); l.select(); try { document.execCommand('copy'); } catch(e){} };

// MODIFIED SHOW GAME INFO TO HIDE HEADER
window.showGameInfo = () => {
    document.getElementById('mainHeader').classList.add('hidden'); // HIDE HEADER
    const list = document.getElementById('infoCategoryList');
    if (!list) return;
    let html = '';
    for (const key in attributeInfo) {
        const info = attributeInfo[key];
        const isBetter = info.logic === 'Hoch gewinnt';
        html += `<div class="p-3 rounded-xl border-2 ${isBetter ? 'border-green-400 bg-green-50' : 'border-blue-400/80 bg-blue-50/50'} mb-2">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-lg font-bold text-gray-800">${info.icon} ${info.name}</span>
                        <span class="text-sm font-semibold ${isBetter ? 'text-green-700' : 'text-blue-700'}">${isBetter ? 'â¬† Hoch' : 'â¬‡ Niedrig'}</span>
                    </div>
                    <p class="text-xs text-gray-700 leading-snug">${info.description || ''}</p>
                 </div>`;
    }
    list.innerHTML = html;
    document.getElementById('gameInfoModal').classList.remove('hidden');
}

// MODIFIED CLOSE GAME INFO TO SHOW HEADER
window.closeGameInfo = () => {
    document.getElementById('gameInfoModal').classList.add('hidden');
    document.getElementById('mainHeader').classList.remove('hidden'); // SHOW HEADER
};

window.closeInfoModal = () => document.getElementById('infoModal').classList.add('hidden');
window.closeLeaderboard = () => { document.getElementById('leaderboardModal').classList.add('hidden'); document.getElementById('gameOverModal').classList.remove('hidden'); };
window.resetGame = () => location.reload();

function closeBottomSheet(){ const bs=document.getElementById('bottomSheet'); const bd=document.getElementById('bottomSheetBackdrop'); bs.classList.add('translate-y-full'); bd.classList.add('opacity-0'); setTimeout(()=>{bs.classList.add('hidden');bd.classList.add('hidden');},300); }
function openBottomSheet(title){ if(title)document.getElementById('resultText').innerText=title; const bs=document.getElementById('bottomSheet'); const bd=document.getElementById('bottomSheetBackdrop'); bd.classList.remove('hidden'); bs.classList.remove('hidden'); setTimeout(()=>{bd.classList.remove('opacity-0'); bs.classList.remove('translate-y-full');},10); }

document.getElementById('bsNextBtn').addEventListener('click',()=> { closeBottomSheet(); window.nextRound(); });

// Settings Listeners
const soundToggle = document.getElementById('soundToggle');
if(soundToggle) { soundToggle.checked = !isMuted; soundToggle.addEventListener('change', function() { isMuted = !this.checked; }); }
const revealToggle = document.getElementById('revealBackToggle');
if(revealToggle) { revealToggle.checked = isOpponentNameBackVisible(); revealToggle.addEventListener('change', function() { setOpponentNameBackVisible(this.checked); if(gameMode === 'ai' && !document.getElementById('gameContainer').classList.contains('hidden')) updateDisplayAI(); }); }
document.getElementById('bsInfoBtn').addEventListener('click', ()=>{ 
    const wood = lastRoundWinningWoodName || (aiGame.currentPlayerCard ? aiGame.currentPlayerCard.name : "Eiche");
    const content = detailedWoodInfo[wood] || `<p>Keine Detailinfo zu ${wood}</p>`;
    const modalContent = document.getElementById('infoModalContent');
    modalContent.innerHTML = `<h4 class="font-bold text-xl mb-2">${wood}</h4>` + content;
    
    const cardData = woodCards.find(c=>c.name===wood);
    if(cardData) {
        const img1 = cardData.imgTree || 'https://placehold.co/400x300?text=Bild+fehlt';
        const img2 = cardData.imgCross || 'https://placehold.co/400x300?text=Detail+fehlt';
        
        modalContent.innerHTML += `
            <div class="grid grid-cols-2 gap-3 mt-4">
                <div>
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Maserung</p>
                    <img src="${img1}" class="w-full h-32 object-cover rounded-lg border border-gray-200 shadow-sm cursor-pointer hover:opacity-90 transition" onclick="window.openImageViewer(this.src)">
                </div>
                <div>
                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Detailansicht</p>
                    <img src="${img2}" class="w-full h-32 object-cover rounded-lg border border-gray-200 shadow-sm cursor-pointer hover:opacity-90 transition" onclick="window.openImageViewer(this.src)">
                </div>
            </div>`;
    }
    
    document.getElementById('infoModal').classList.remove('hidden');
});

const p=new URLSearchParams(window.location.search);
if(p.get('game')){ 
    document.getElementById('setupModal').classList.add('hidden');
    gameId=p.get('game'); 
    window.showNamePrompt('join'); 
}

// IMAGE VIEWER LOGIC (LIGHTBOX)
window.openImageViewer = (src) => {
    document.getElementById('fullSizeImage').src = src;
    document.getElementById('imageViewerModal').classList.remove('hidden');
};
window.closeImageViewer = () => {
    document.getElementById('imageViewerModal').classList.add('hidden');
};
</script>
</body>
</html>
